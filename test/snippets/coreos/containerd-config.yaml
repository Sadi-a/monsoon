variant: flatcar
version: 1.0.0
storage:
  directories:
    - path: /etc/containerd
      mode: 0755
    - path: /etc/systemd/system/containerd.service.d
      mode: 0755
    - path: /etc/systemd/system/containerd/certs.d/docker.io
      mode: 0755
    - path: /etc/systemd/system/containerd/certs.d/us-docker.pkg.dev
      mode: 0755
  files:
    - path: /etc/systemd/system/containerd/certs.d/docker.io/hosts.toml
      mode: 0644
      contents:
        inline: |
          # https://github.com/containerd/containerd/blob/main/docs/hosts.md
          server = "https://registry-1.docker.io"
          host."https://registry-mirror.infra.corp.arista.io".capabilities = ["pull", "resolve"]
    - path: /etc/systemd/system/containerd/certs.d/us-docker.pkg.dev/hosts.toml
      mode: 0644
      contents:
        inline: |
          # https://github.com/containerd/containerd/blob/main/docs/hosts.md
          server = "https://us-docker.pkg.dev"
          [header]
            User-Agent = "cri-kubelet/1.22.17 (linux; arista-internal-k8s; cluster-infra)"
    - path: /etc/systemd/system/containerd.service.d/10-use-custom-config.conf
      mode: 0644
      contents:
        inline: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/containerd
    - path: /etc/crictl.yaml
      mode: 0644
      contents:
        inline: |
          # https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md
          runtime-endpoint: unix:///run/containerd/containerd.sock
          image-endpoint: unix:///run/containerd/containerd.sock
          # timeout (in seconds) for connecting to runtime server
          timeout: 10
    - path: /etc/containerd/config.toml
      mode: 0644
      contents:
        inline: |
          version = 2
          # persistent data location
          root = "/var/lib/containerd"
          # runtime state information
          state = "/run/containerd"
          # set containerd as a subreaper on linux when it is not running as PID 1
          subreaper = true
          # set containerd's OOM score
          oom_score = -999
          disabled_plugins = []
          # grpc configuration
          [grpc]
          address = "/run/containerd/containerd.sock"
          # socket uid
          uid = 0
          # socket gid
          gid = 0
          [plugins."containerd.runtime.v1.linux"]
          # shim binary name/path
          shim = "containerd-shim"
          # runtime binary name/path
          runtime = "runc"
          # do not use a shim when starting containers, saves on memory but
          # live restore is not supported
          no_shim = false
          [plugins."io.containerd.grpc.v1.cri"]
          # enable SELinux labeling
          enable_selinux = true
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          runtime_type = "io.containerd.runc.v2"

          # setting runc.options unsets parent settings
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
          SystemdCgroup = false

          [plugins."io.containerd.grpc.v1.cri".registry]
          config_path = "/etc/containerd/certs.d"
